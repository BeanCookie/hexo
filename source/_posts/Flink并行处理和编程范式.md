---
title: Flink并行处理和编程范式
date: 2021-11-09 16:56:17
categories:
- Flink
tags: 
- Flink
---

### 什么是并行处理
众所周知，对于计算密集型或数据密集型这样需要计算量比较大的工作，并行计
算或分而治之是解决这一类问题非常有效的手段。在这个手段中比较关键的部分是，如何对计算资源进行合理分配。

举个栗子，假设面包店制作面包需要经过三道工序，分别为A：将面粉、鸡蛋和糖等原料加工成面团，B：将面团放入烤箱烘焙，C：将烘焙好的面包放进包装袋。

1. 方式一：将三道工序分配给不同的工人操作，这种方式，每个工序制作完成之后，可以把制作中的面包传给下一个员工，从而形成一种流水线的工作效果。但是在不增加流水线数量的情况下，这种流水线的协作方式会随着员工数量的增加而难以继续扩展。

2. 方式二：同一工序允许多个员工来共同操作，比如 A 工序由两个员工共同操作，B 工序由三个员工操作，C 工序只由一个员工操作。这时候我们就需要考虑怎样进一步的对计算任务做划分。比如，可以把全部员工分成三组，第一组负责 A 工序，第二个组负责 B 工序，第三个组负责 C工序。第一个组的呀u能够给你可以再次在组内进行分工，比如 A 组里第一个员工准备一半的面团，第二个员工批准备另一半的面团。他们分别完成了之后，再将自己手里的半成品面包传递给下一个组。

像上述按照面包制作工序进行划分，以及将面包本身进行划分，就是所谓的计算的并行性和数据并行性。

### Flink中的并行操作
![https://beancookie.github.io/images/Flink并行处理和编程范式-01.png](https://beancookie.github.io/images/Flink并行处理和编程范式-01.png)

在图中，处理工序A的员工，假设还承担了一些额外任务，比如把面粉搬运到厨房；负责工序C的员工也有额外任务，就是等所有员工把面包制作好后，还需将面包搬运到商店货架。据此，可以把图中所有的节点划分为三个类别。第一个类别；第二类是数据处理节点；它们大多时候不需要和外部系统打交道；最后一个类别负责将整个计算逻辑写到某个外部系统。这三类节点分别就是Source节点、Transform节点和Sink节点。

### 编程范式

假设有一个数据集，其中包含 1~10 十个数字，如果把每一个数字都乘以 2并做累计求和操作，怎么实现呢？办法有很多，如果用编程来解决有两个角度：

1. 命令式编程

   一步一步的相当 于告诉机器应该怎样生成一些数据结构，怎样的用这些数据结构去存储一些临时的中 间结果，怎样把这些中间结果再转换成为最终的结果，相当于一步一步告诉机器如何去做。

   ```java
   int[] numbers = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10};
   int sum = 0;
   for (int i = 0; i < numbers.length; i++) {
       numbers[i] = numbers[i] * 2;
       sum += numbers[i];
   }
   System.out.println(sum);
   ```

2. 声明式编程

   声明式编程里通常只需要告诉机器去完成怎样的任务，而不需要像命令式那样详细传递。

   ```java
   int sum = Stream.of(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10).map(x -> x * 2).mapToInt(x -> x).sum();
   System.out.println(sum);
   ```

### Flink对多范式的支持

#### FlinkAPI概览
![https://beancookie.github.io/images/Flink并行处理和编程范式-02.png](https://beancookie.github.io/images/Flink并行处理和编程范式-02.png)

在旧版本的 Flink 里，它的API层次是自上而下的。最上层表示我们可以用比较高级的API，或者说声明程度更高的Table API以及SQL的方式来编写逻辑。所有SQL和Table API编写的内容都会被Flink内部翻译和优化成一个用DataStream API实现的程序。再往下一层，DataStream API 的程序会被表示成为一系列Transformation，最终Transformation会被翻译成JobGraph。

新版本的Flink在流批一体这一目标的引导下，Flink现在已经对底层的算子、调度、Shuffle 进行了统一的抽象，以统一的方式向上支持 DataStream API和Table API两套接口。 DataStream API是一种比较偏物理层的接口，Table API是一种 Declearetive 的接口， 这两套接口对流和批来说都是统一的。